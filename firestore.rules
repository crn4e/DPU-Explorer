/**
 * This ruleset establishes a public-read, admin-write security model for the DPU Explorer application.
 *
 * Core Philosophy:
 * Data related to campus locations and their announcements is publicly readable by all users,
 * including those who are not authenticated. All write operations (creating, updating, deleting data)
 * are strictly restricted to authorized administrators.
 *
 * Data Structure:
 * - /locations/{locationId}: Top-level collection for all campus location documents.
 * - /locations/{locationId}/announcements/{announcementId}: Subcollection for announcements specific to a location.
 * - /admins/{uid}: A dedicated collection to manage admin roles. The existence of a document
 *   with a user's UID in this collection grants them administrative privileges across the database.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to abstract and reuse logic across the ruleset.

    /**
     * Checks if the current user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the user's UID matches the document's ID they are trying to access.
     * This is the cornerstone of owner-based security rules.
     */
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /**
     * Checks if the currently signed-in user is an administrator.
     * Admin status is granted if a document with the user's UID exists in the /admins collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * Checks if the currently signed-in user is a developer.
     * Dev status is granted if a document with the user's UID exists in the /admins collection.
     * This might be expanded in the future for more granular dev roles.
     */
    function isDev() {
      // For now, developers are also admins
      return isAdmin();
    }
    
    /**
     * Checks if the user is an Announcement Admin.
     */
    function isAnnouncementAdmin() {
        return isSignedIn() && exists(/databases/$(database)/documents/announcementAdmins/$(request.auth.uid));
    }


    /**
     * @description Enforces a public-read, admin-only write access model for locations.
     * @path /locations/{locationId}
     * @allow (get) Any user, signed-in or anonymous, can read a location document.
     * @allow (create) An admin user (auth.uid is in /admins) can create a new location.
     * @deny (update) A regular signed-in user attempts to update a location's name.
     * @principle Implements a global role-based access control for content management.
     */
    match /locations/{locationId} {
      allow get, list: if true;
      allow create, update, delete: if isDev() || isAdmin();
    }

    /**
     * @description Enforces a public-read, admin-only write model for location-specific announcements.
     * @path /locations/{locationId}/announcements/{announcementId}
     * @allow (list) Any user can list all announcements for a given location.
     * @allow (create) An admin creates an announcement, ensuring the 'locationId' in the document data matches the parent path.
     * @deny (create) An admin attempts to create an announcement where the 'locationId' in the data does not match the path.
     * @principle Validates relational integrity between a subcollection document and its parent.
     */
    match /locations/{locationId}/announcements/{announcementId} {
      allow get, list: if true;
      allow create: if isAnnouncementAdmin() && request.resource.data.locationId == locationId;
      allow update: if isAnnouncementAdmin() && resource != null && request.resource.data.locationId == resource.data.locationId;
      allow delete: if isAnnouncementAdmin() && resource != null;
    }

    /**
     * @description Manages access to the administrators collection. Only Devs can manage Admins.
     * @path /admins/{uid}
     * @allow (create) An existing dev user adds a new user's UID to the collection, granting them admin rights.
     * @deny (list) A non-dev user attempts to list all administrator UIDs.
     * @principle Prevents privilege escalation by restricting role management to higher-level users.
     */
    match /admins/{uid} {
      allow get: if isOwner(uid) || isDev();
      allow list, create, delete: if isDev();
      allow update: if false; // Disallow updating admin documents.
    }
    
     /**
     * @description Manages access to the announcement administrators collection. Only Devs can manage them.
     * @path /announcementAdmins/{uid}
     */
    match /announcementAdmins/{uid} {
      allow get: if isOwner(uid) || isDev() || isAnnouncementAdmin();
      allow list, create, delete: if isDev();
      allow update: if false; 
    }

    /**
     * @description Manages access to student profiles.
     * @path /students/{uid}
     */
    match /students/{uid} {
      allow get: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      allow delete: if false;
    }
  }
}
