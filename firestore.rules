/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * Access is dictated by roles defined in dedicated collections: `/admins` for developers
 * with full control, and `/announcementAdmins` for users who can only manage announcements.
 *
 * Data Structure: The data is structured around a central '/locations' collection.
 * Each location document can contain '/announcements' and '/images' subcollections.
 * A top-level '/openingHours' collection is linked to locations.
 *
 * Key Security Decisions:
 * - Public Read-Only Access: All primary data collections ('/locations', '/openingHours',
 *   and their subcollections) are publicly readable to support the app's function
 *   as a campus explorer.
 * - Granular Write Controls:
 *   - Developers (`isAdmin()`): Have full CUD (Create, Update, Delete) access to all data.
 *   - Announcement Admins (`isAnnouncementAdmin()`): Can only update the `announcement` field
 *     on existing `locations` documents. They cannot create, delete, or modify other fields.
 * - Role List Protection: The lists of administrators are protected, but users are allowed
 *   to read their OWN role document to verify their permissions upon login.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to abstract and simplify rule logic.
    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isAnnouncementAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/announcementAdmins/$(request.auth.uid));
    }

    match /locations/{locationId} {
      allow get, list: if true;
      allow create, delete: if isAdmin();
      // Allow full update for Devs
      allow update: if isAdmin();
      // Allow Announcement Admins to update ONLY the 'announcement' field.
      allow update: if isAnnouncementAdmin() && request.writeFields.hasOnly(['announcement']);
    }

    match /locations/{locationId}/announcements/{announcementId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    match /locations/{locationId}/images/{imageId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    match /openingHours/{openingHoursId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Admins can manage other admins, and users can read their own admin status.
    match /admins/{userId} {
      allow get: if isSelf(userId) || isAdmin();
      allow list, write: if isAdmin();
    }
    
    // Admins can manage announcement admins, and users can read their own status.
    match /announcementAdmins/{userId} {
      allow get: if isSelf(userId) || isAdmin();
      allow list, write: if isAdmin();
    }
  }
}
