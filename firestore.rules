/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * Access is dictated by roles defined in dedicated collections: `/admins` for developers
 * with full control, and `/announcementAdmins` for users who can only manage announcements.
 *
 * Data Structure: The data is structured around a central '/locations' collection.
 * Each location document can contain '/announcements' and '/images' subcollections.
 * A top-level '/openingHours' collection is linked to locations.
 *
 * Key Security Decisions:
 * - Public Read-Only Access: All primary data collections ('/locations', '/openingHours',
 *   and their subcollections) are publicly readable to support the app's function
 *   as a campus explorer.
 * - Granular Write Controls:
 *   - Developers (`isAdmin()`): Have full CUD (Create, Update, Delete) access to all data.
 *   - Announcement Admins (`isAnnouncementAdmin()`): Can only update the `announcement` field
 *     on existing `locations` documents. They cannot create, delete, or modify other fields.
 * - Role List Protection: The lists of administrators are not publicly readable.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to abstract and simplify rule logic.
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isAnnouncementAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/announcementAdmins/$(request.auth.uid));
    }

    match /locations/{locationId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      // Allow full update/delete for Devs
      allow update, delete: if isAdmin();
      // Allow specific field update for Announcement Admins
      allow update: if isAnnouncementAdmin()
                    && request.resource.data.keys().hasOnly(['announcement'])
                    && request.resource.data.name == resource.data.name; // Cannot change name
    }

    match /locations/{locationId}/announcements/{announcementId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /locations/{locationId}/images/{imageId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /openingHours/{openingHoursId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    match /admins/{userId} {
      allow read, write: if isAdmin();
    }
    
    match /announcementAdmins/{userId} {
      allow read: if isAdmin() || (isAnnouncementAdmin() && request.auth.uid == userId);
      allow write: if isAdmin();
    }
  }
}
