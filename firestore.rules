/**
 * This ruleset establishes a public-read, admin-write security model for the DPU Explorer application.
 *
 * Core Philosophy:
 * Data related to campus locations and their announcements is publicly readable by all users,
 * including those who are not authenticated. All write operations (creating, updating, deleting data)
 * are strictly restricted to authorized administrators.
 *
 * Data Structure:
 * - /locations/{locationId}: Top-level collection for all campus location documents.
 * - /locations/{locationId}/announcements/{announcementId}: Subcollection for announcements specific to a location.
 * - /admins/{uid}: A dedicated collection to manage admin roles. The existence of a document
 *   with a user's UID in this collection grants them administrative privileges across the database.
 *
 * Key Security Decisions:
 * - Public Read Access: The `/locations` and nested `/announcements` collections are publicly readable
 *   to ensure the app is accessible to everyone, including anonymous users.
 * - Centralized Admin Roles: Admin status is determined by checking for a user's UID in the `/admins` collection.
 *   This avoids embedding role information in individual documents and provides a single source of truth for admin privileges.
 * - Admin Collection Security: The `/admins` collection itself is secured. Only existing admins can view, add, or remove
 *   other administrators, preventing unauthorized privilege escalation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to abstract and reuse logic across the ruleset.

    /**
     * Checks if the current user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently signed-in user is an administrator.
     * Admin status is granted if a document with the user's UID exists in the /admins collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * @description Enforces a public-read, admin-only write access model for locations.
     * @path /locations/{locationId}
     * @allow (get) Any user, signed-in or anonymous, can read a location document.
     * @allow (create) An admin user (auth.uid is in /admins) can create a new location.
     * @deny (update) A regular signed-in user attempts to update a location's name.
     * @principle Implements a global role-based access control for content management.
     */
    match /locations/{locationId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Enforces a public-read, admin-only write model for location-specific announcements.
     * @path /locations/{locationId}/announcements/{announcementId}
     * @allow (list) Any user can list all announcements for a given location.
     * @allow (create) An admin creates an announcement, ensuring the 'locationId' in the document data matches the parent path.
     * @deny (create) An admin attempts to create an announcement where the 'locationId' in the data does not match the path.
     * @principle Validates relational integrity between a subcollection document and its parent.
     */
    match /locations/{locationId}/announcements/{announcementId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.locationId == locationId;
      allow update: if isAdmin() && resource != null && request.resource.data.locationId == resource.data.locationId;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages access to the administrators collection.
     * @path /admins/{uid}
     * @allow (create) An existing admin user adds a new user's UID to the collection, granting them admin rights.
     * @deny (list) A non-admin user attempts to list all administrator UIDs.
     * @deny (create) A non-admin user attempts to add their own UID to the collection.
     * @principle Prevents privilege escalation and protects administrator identities by restricting management of the role collection to its members.
     */
    match /admins/{uid} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin() && resource != null;
    }
  }
}
